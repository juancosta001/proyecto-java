package com.ypacarai.cooperativa.activos.util;

import java.io.File;
import java.io.FileOutputStream;
import java.io.FileWriter;
import java.io.IOException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Map;

import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JOptionPane;
import javax.swing.filechooser.FileNameExtensionFilter;

import org.apache.poi.ss.usermodel.BorderStyle;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.CellStyle;
import org.apache.poi.ss.usermodel.FillPatternType;
import org.apache.poi.ss.usermodel.Font;
import org.apache.poi.ss.usermodel.HorizontalAlignment;
import org.apache.poi.ss.usermodel.IndexedColors;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;

import com.ypacarai.cooperativa.activos.model.ReporteCompleto;

/**
 * Utilidad para exportación de reportes en múltiples formatos (CSV, Excel, PDF)
 * Implementación completa con Apache POI e iText
 */
public class ExportadorReportes {
    
    private static final DateTimeFormatter FORMATO_FECHA_ARCHIVO = DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss");
    
    /**
     * Exporta un reporte a Excel (XLSX)
     */
    public static boolean exportarExcel(ReporteCompleto reporte, JFrame ventanaPadre) {
        try {
            // Seleccionar archivo de destino
            JFileChooser fileChooser = new JFileChooser();
            fileChooser.setDialogTitle("Exportar Reporte a Excel");
            
            String nombreArchivo = "reporte_" + reporte.getTipoReporte().toLowerCase().replace(" ", "_") + 
                                  "_" + LocalDateTime.now().format(FORMATO_FECHA_ARCHIVO) + ".xlsx";
            fileChooser.setSelectedFile(new File(nombreArchivo));
            
            FileNameExtensionFilter filter = new FileNameExtensionFilter("Archivos Excel (*.xlsx)", "xlsx");
            fileChooser.setFileFilter(filter);
            
            int resultado = fileChooser.showSaveDialog(ventanaPadre);
            if (resultado == JFileChooser.APPROVE_OPTION) {
                File archivo = fileChooser.getSelectedFile();
                if (!archivo.getName().toLowerCase().endsWith(".xlsx")) {
                    archivo = new File(archivo.getAbsolutePath() + ".xlsx");
                }
                
                escribirExcel(reporte, archivo);
                
                JOptionPane.showMessageDialog(ventanaPadre, 
                    "Reporte exportado exitosamente a:\n" + archivo.getAbsolutePath(),
                    "Exportación Exitosa", 
                    JOptionPane.INFORMATION_MESSAGE);
                return true;
            }
            
        } catch (Exception e) {
            e.printStackTrace();
            JOptionPane.showMessageDialog(ventanaPadre, 
                "Error exportando reporte a Excel: " + e.getMessage(),
                "Error de Exportación", 
                JOptionPane.ERROR_MESSAGE);
        }
        return false;
    }
    
    /**
     * Exporta un reporte a CSV
     */
    public static boolean exportarCSV(ReporteCompleto reporte, JFrame ventanaPadre) {
        try {
            // Seleccionar archivo de destino
            JFileChooser fileChooser = new JFileChooser();
            fileChooser.setDialogTitle("Exportar Reporte a CSV");
            
            String nombreArchivo = "reporte_" + reporte.getTipoReporte().toLowerCase().replace(" ", "_") + 
                                  "_" + LocalDateTime.now().format(FORMATO_FECHA_ARCHIVO) + ".csv";
            fileChooser.setSelectedFile(new File(nombreArchivo));
            
            FileNameExtensionFilter filter = new FileNameExtensionFilter("Archivos CSV (*.csv)", "csv");
            fileChooser.setFileFilter(filter);
            
            int resultado = fileChooser.showSaveDialog(ventanaPadre);
            if (resultado == JFileChooser.APPROVE_OPTION) {
                File archivo = fileChooser.getSelectedFile();
                if (!archivo.getName().toLowerCase().endsWith(".csv")) {
                    archivo = new File(archivo.getAbsolutePath() + ".csv");
                }
                
                escribirCSV(reporte, archivo);
                
                JOptionPane.showMessageDialog(ventanaPadre, 
                    "Reporte exportado exitosamente a:\n" + archivo.getAbsolutePath(),
                    "Exportación Exitosa", 
                    JOptionPane.INFORMATION_MESSAGE);
                return true;
            }
            
        } catch (Exception e) {
            JOptionPane.showMessageDialog(ventanaPadre, 
                "Error exportando reporte: " + e.getMessage(),
                "Error de Exportación", 
                JOptionPane.ERROR_MESSAGE);
        }
        return false;
    }
    
    /**
     * Exporta un reporte a PDF - Implementación simplificada
     */
    public static boolean exportarPDF(ReporteCompleto reporte, JFrame ventanaPadre) {
        // Por ahora, mostrar mensaje informativo y ofrecer CSV como alternativa
        int opcion = JOptionPane.showConfirmDialog(ventanaPadre,
            "La exportación a PDF está en desarrollo.\n" +
            "¿Desea exportar a CSV como alternativa? Es compatible con muchos programas.",
            "Exportar Reporte",
            JOptionPane.YES_NO_OPTION,
            JOptionPane.QUESTION_MESSAGE);
            
        if (opcion == JOptionPane.YES_OPTION) {
            return exportarCSV(reporte, ventanaPadre);
        }
        return false;
    }
    
    // ================== IMPLEMENTACIÓN EXCEL ==================
    
    private static void escribirExcel(ReporteCompleto reporte, File archivo) throws IOException {
        try (Workbook workbook = new XSSFWorkbook();
             FileOutputStream fileOut = new FileOutputStream(archivo)) {
            
            // Crear hoja principal
            Sheet sheet = workbook.createSheet("Reporte");
            
            // Configurar estilos
            CellStyle headerStyle = crearEstiloHeader(workbook);
            CellStyle titleStyle = crearEstiloTitulo(workbook);
            CellStyle dataStyle = crearEstiloDatos(workbook);
            
            int rowNum = 0;
            
            // Título del reporte
            Row titleRow = sheet.createRow(rowNum++);
            Cell titleCell = titleRow.createCell(0);
            titleCell.setCellValue("REPORTE: " + reporte.getTipoReporte());
            titleCell.setCellStyle(titleStyle);
            
            // Información del reporte
            rowNum = agregarInfoReporte(sheet, reporte, rowNum, dataStyle);
            rowNum += 2; // Espacio
            
            // Datos principales
            escribirDatosExcelPorTipo(sheet, reporte, rowNum, headerStyle, dataStyle);
            
            // Ajustar ancho de columnas
            for (int i = 0; i < 10; i++) {
                sheet.autoSizeColumn(i);
            }
            
            workbook.write(fileOut);
        }
    }
    
    private static CellStyle crearEstiloHeader(Workbook workbook) {
        CellStyle style = workbook.createCellStyle();
        Font font = workbook.createFont();
        font.setBold(true);
        font.setColor(IndexedColors.WHITE.getIndex());
        style.setFont(font);
        style.setFillForegroundColor(IndexedColors.DARK_BLUE.getIndex());
        style.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        style.setBorderBottom(BorderStyle.THIN);
        style.setBorderTop(BorderStyle.THIN);
        style.setBorderRight(BorderStyle.THIN);
        style.setBorderLeft(BorderStyle.THIN);
        style.setAlignment(HorizontalAlignment.CENTER);
        return style;
    }
    
    private static CellStyle crearEstiloTitulo(Workbook workbook) {
        CellStyle style = workbook.createCellStyle();
        Font font = workbook.createFont();
        font.setBold(true);
        font.setFontHeightInPoints((short) 16);
        style.setFont(font);
        return style;
    }
    
    private static CellStyle crearEstiloDatos(Workbook workbook) {
        CellStyle style = workbook.createCellStyle();
        style.setBorderBottom(BorderStyle.THIN);
        style.setBorderTop(BorderStyle.THIN);
        style.setBorderRight(BorderStyle.THIN);
        style.setBorderLeft(BorderStyle.THIN);
        return style;
    }
    
    private static int agregarInfoReporte(Sheet sheet, ReporteCompleto reporte, int rowNum, CellStyle style) {
        // Fecha de generación
        Row row = sheet.createRow(rowNum++);
        Cell cell = row.createCell(0);
        cell.setCellValue("Fecha de Generación:");
        cell = row.createCell(1);
        cell.setCellValue(formatearFecha(reporte.getFechaGeneracion()));
        
        // Total de registros
        row = sheet.createRow(rowNum++);
        cell = row.createCell(0);
        cell.setCellValue("Total de Registros:");
        cell = row.createCell(1);
        cell.setCellValue(reporte.getTotalRegistros());
        
        // Resumen ejecutivo
        if (reporte.getResumenEjecutivo() != null && !reporte.getResumenEjecutivo().isEmpty()) {
            row = sheet.createRow(rowNum++);
            cell = row.createCell(0);
            cell.setCellValue("Resumen Ejecutivo:");
            cell = row.createCell(1);
            cell.setCellValue(reporte.getResumenEjecutivo());
        }
        
        return rowNum;
    }
    
    // ================== IMPLEMENTACIÓN CSV ==================
    
    private static void escribirCSV(ReporteCompleto reporte, File archivo) throws IOException {
        try (FileWriter writer = new FileWriter(archivo, java.nio.charset.StandardCharsets.UTF_8)) {
            // Encabezado del reporte
            writer.write("REPORTE: " + reporte.getTipoReporte() + "\n");
            writer.write("GENERADO: " + reporte.getFechaGeneracion() + "\n");
            writer.write("TOTAL REGISTROS: " + reporte.getTotalRegistros() + "\n");
            writer.write("\n");
            
            // Resumen ejecutivo
            if (reporte.getResumenEjecutivo() != null && !reporte.getResumenEjecutivo().isEmpty()) {
                writer.write("RESUMEN EJECUTIVO:\n");
                String[] lineasResumen = reporte.getResumenEjecutivo().split("\n");
                for (String linea : lineasResumen) {
                    writer.write("\"" + linea.replace("\"", "\"\"") + "\"\n");
                }
                writer.write("\n");
            }
            
            // Estadísticas
            if (reporte.getEstadisticas() != null && !reporte.getEstadisticas().isEmpty()) {
                writer.write("ESTADISTICAS PRINCIPALES:\n");
                for (Map.Entry<String, Object> stat : reporte.getEstadisticas().entrySet()) {
                    writer.write(stat.getKey() + "," + stat.getValue() + "\n");
                }
                writer.write("\n");
            }
            
            // Datos principales
            writer.write("DATOS DETALLADOS:\n");
            escribirDatosCSVPorTipo(reporte, writer);
        }
    }
    
    // ================== MÉTODOS ESPECÍFICOS POR TIPO DE REPORTE ==================
    
    private static void escribirDatosExcelPorTipo(Sheet sheet, ReporteCompleto reporte, int startRow, 
                                                 CellStyle headerStyle, CellStyle dataStyle) {
        List<?> datos = reporte.getDatosOriginales();
        if (datos == null || datos.isEmpty()) {
            Row row = sheet.createRow(startRow);
            Cell cell = row.createCell(0);
            cell.setCellValue("No hay datos para mostrar");
            return;
        }
        
        String tipoReporte = reporte.getTipoReporte();
        switch (tipoReporte) {
            case "Estado de Activos":
                escribirExcelEstadoActivos(sheet, datos, startRow, headerStyle, dataStyle);
                break;
            case "Mantenimientos":
                escribirExcelMantenimientos(sheet, datos, startRow, headerStyle, dataStyle);
                break;
            case "Fallas":
                escribirExcelFallas(sheet, datos, startRow, headerStyle, dataStyle);
                break;
            case "Traslados":
                escribirExcelTraslados(sheet, datos, startRow, headerStyle, dataStyle);
                break;
            default:
                Row row = sheet.createRow(startRow);
                Cell cell = row.createCell(0);
                cell.setCellValue("Tipo de reporte no soportado: " + tipoReporte);
        }
    }
    
    private static void escribirDatosCSVPorTipo(ReporteCompleto reporte, FileWriter writer) throws IOException {
        List<?> datos = reporte.getDatosOriginales();
        if (datos == null || datos.isEmpty()) {
            writer.write("No hay datos para mostrar\n");
            return;
        }
        
        String tipoReporte = reporte.getTipoReporte();
        switch (tipoReporte) {
            case "Estado de Activos":
                escribirCSVEstadoActivos(datos, writer);
                break;
            case "Mantenimientos":
                escribirCSVMantenimientos(datos, writer);
                break;
            case "Fallas":
                escribirCSVFallas(datos, writer);
                break;
            case "Traslados":
                escribirCSVTraslados(datos, writer);
                break;
            default:
                writer.write("Tipo de reporte no soportado para exportación CSV\n");
        }
    }
    
    // Estado de Activos - Excel
    @SuppressWarnings("unchecked")
    private static void escribirExcelEstadoActivos(Sheet sheet, List<?> datos, int startRow, 
                                                  CellStyle headerStyle, CellStyle dataStyle) {
        List<com.ypacarai.cooperativa.activos.model.ReporteEstadoActivos> reportes = 
            (List<com.ypacarai.cooperativa.activos.model.ReporteEstadoActivos>) datos;
        
        // Headers
        Row headerRow = sheet.createRow(startRow++);
        String[] headers = {"Tipo Activo", "Estado", "Cantidad", "Ubicación", "Próx. Mant.", "Mant. Vencido", "Fecha"};
        for (int i = 0; i < headers.length; i++) {
            Cell cell = headerRow.createCell(i);
            cell.setCellValue(headers[i]);
            cell.setCellStyle(headerStyle);
        }
        
        // Data
        for (com.ypacarai.cooperativa.activos.model.ReporteEstadoActivos item : reportes) {
            Row row = sheet.createRow(startRow++);
            row.createCell(0).setCellValue(item.getTipoActivo());
            row.createCell(1).setCellValue(item.getEstado());
            row.createCell(2).setCellValue(item.getCantidadTotal());
            row.createCell(3).setCellValue(item.getUbicacion());
            row.createCell(4).setCellValue(item.getActivosProximosMantenimiento());
            row.createCell(5).setCellValue(item.getActivosMantenimientoVencido());
            row.createCell(6).setCellValue(formatearFecha(item.getFechaConsulta()));
            
            // Aplicar estilo a todas las celdas
            for (int i = 0; i < 7; i++) {
                row.getCell(i).setCellStyle(dataStyle);
            }
        }
    }
    
    // Estado de Activos - CSV
    @SuppressWarnings("unchecked")
    private static void escribirCSVEstadoActivos(List<?> datos, FileWriter writer) throws IOException {
        List<com.ypacarai.cooperativa.activos.model.ReporteEstadoActivos> reportes = 
            (List<com.ypacarai.cooperativa.activos.model.ReporteEstadoActivos>) datos;
        
        // Headers
        writer.write("Tipo Activo,Estado,Cantidad Total,Ubicacion,Proximos Mantenimiento,Mantenimiento Vencido,Fecha Consulta\n");
        
        // Data
        for (com.ypacarai.cooperativa.activos.model.ReporteEstadoActivos item : reportes) {
            writer.write(String.format("%s,%s,%d,%s,%d,%d,%s\n",
                csvEscape(item.getTipoActivo()),
                csvEscape(item.getEstado()),
                item.getCantidadTotal(),
                csvEscape(item.getUbicacion()),
                item.getActivosProximosMantenimiento(),
                item.getActivosMantenimientoVencido(),
                formatearFecha(item.getFechaConsulta())
            ));
        }
    }
    
    // Mantenimientos - Excel
    @SuppressWarnings("unchecked")
    private static void escribirExcelMantenimientos(Sheet sheet, List<?> datos, int startRow, 
                                                   CellStyle headerStyle, CellStyle dataStyle) {
        List<com.ypacarai.cooperativa.activos.model.ReporteMantenimientos> reportes = 
            (List<com.ypacarai.cooperativa.activos.model.ReporteMantenimientos>) datos;
        
        // Headers
        Row headerRow = sheet.createRow(startRow++);
        String[] headers = {"Tipo Mant.", "Tipo Activo", "Total Mant.", "Tiempo Prom. (h)", "Técnico", "Costo", "Estado"};
        for (int i = 0; i < headers.length; i++) {
            Cell cell = headerRow.createCell(i);
            cell.setCellValue(headers[i]);
            cell.setCellStyle(headerStyle);
        }
        
        // Data
        for (com.ypacarai.cooperativa.activos.model.ReporteMantenimientos item : reportes) {
            Row row = sheet.createRow(startRow++);
            row.createCell(0).setCellValue(item.getTipoMantenimiento());
            row.createCell(1).setCellValue(item.getTipoActivo());
            row.createCell(2).setCellValue(item.getTotalMantenimientos());
            row.createCell(3).setCellValue(item.getTiempoPromedioResolucion());
            row.createCell(4).setCellValue(item.getTecnicoAsignado());
            row.createCell(5).setCellValue(item.getCostoTotal());
            row.createCell(6).setCellValue(item.getEstadoMantenimiento());
            
            // Aplicar estilo
            for (int i = 0; i < 7; i++) {
                row.getCell(i).setCellStyle(dataStyle);
            }
        }
    }
    
    // Mantenimientos - CSV
    @SuppressWarnings("unchecked")
    private static void escribirCSVMantenimientos(List<?> datos, FileWriter writer) throws IOException {
        List<com.ypacarai.cooperativa.activos.model.ReporteMantenimientos> reportes = 
            (List<com.ypacarai.cooperativa.activos.model.ReporteMantenimientos>) datos;
        
        // Headers
        writer.write("Tipo Mantenimiento,Tipo Activo,Total Mantenimientos,Tiempo Promedio (h),Tecnico Asignado,Costo Total,Estado\n");
        
        // Data
        for (com.ypacarai.cooperativa.activos.model.ReporteMantenimientos item : reportes) {
            writer.write(String.format("%s,%s,%d,%.2f,%s,%.2f,%s\n",
                csvEscape(item.getTipoMantenimiento()),
                csvEscape(item.getTipoActivo()),
                item.getTotalMantenimientos(),
                item.getTiempoPromedioResolucion(),
                csvEscape(item.getTecnicoAsignado()),
                item.getCostoTotal(),
                csvEscape(item.getEstadoMantenimiento())
            ));
        }
    }
    
    // Fallas - Excel
    @SuppressWarnings("unchecked")
    private static void escribirExcelFallas(Sheet sheet, List<?> datos, int startRow, 
                                           CellStyle headerStyle, CellStyle dataStyle) {
        List<com.ypacarai.cooperativa.activos.model.ReporteFallas> reportes = 
            (List<com.ypacarai.cooperativa.activos.model.ReporteFallas>) datos;
        
        // Headers
        Row headerRow = sheet.createRow(startRow++);
        String[] headers = {"Tipo Activo", "Número", "Descripción", "Frecuencia", "Efectividad (%)", "Última Falla"};
        for (int i = 0; i < headers.length; i++) {
            Cell cell = headerRow.createCell(i);
            cell.setCellValue(headers[i]);
            cell.setCellStyle(headerStyle);
        }
        
        // Data
        for (com.ypacarai.cooperativa.activos.model.ReporteFallas item : reportes) {
            Row row = sheet.createRow(startRow++);
            row.createCell(0).setCellValue(item.getTipoActivo());
            row.createCell(1).setCellValue(item.getNumeroActivo());
            row.createCell(2).setCellValue(item.getDescripcionFalla());
            row.createCell(3).setCellValue(item.getFrecuenciaFallas());
            row.createCell(4).setCellValue(item.getEfectividadReparacion());
            row.createCell(5).setCellValue(formatearFecha(item.getFechaUltimaFalla()));
            
            // Aplicar estilo
            for (int i = 0; i < 6; i++) {
                row.getCell(i).setCellStyle(dataStyle);
            }
        }
    }
    
    // Fallas - CSV
    @SuppressWarnings("unchecked")
    private static void escribirCSVFallas(List<?> datos, FileWriter writer) throws IOException {
        List<com.ypacarai.cooperativa.activos.model.ReporteFallas> reportes = 
            (List<com.ypacarai.cooperativa.activos.model.ReporteFallas>) datos;
        
        // Headers
        writer.write("Tipo Activo,Numero Activo,Descripcion Falla,Frecuencia,Efectividad Reparacion (%),Fecha Ultima Falla\n");
        
        // Data
        for (com.ypacarai.cooperativa.activos.model.ReporteFallas item : reportes) {
            writer.write(String.format("%s,%s,%s,%d,%.2f,%s\n",
                csvEscape(item.getTipoActivo()),
                csvEscape(item.getNumeroActivo()),
                csvEscape(item.getDescripcionFalla()),
                item.getFrecuenciaFallas(),
                item.getEfectividadReparacion(),
                formatearFecha(item.getFechaUltimaFalla())
            ));
        }
    }
    
    // Traslados - Excel
    @SuppressWarnings("unchecked")
    private static void escribirExcelTraslados(Sheet sheet, List<?> datos, int startRow, 
                                              CellStyle headerStyle, CellStyle dataStyle) {
        List<com.ypacarai.cooperativa.activos.model.ReporteTraslados> reportes = 
            (List<com.ypacarai.cooperativa.activos.model.ReporteTraslados>) datos;
        
        // Headers
        Row headerRow = sheet.createRow(startRow++);
        String[] headers = {"Número", "Tipo Activo", "Origen", "Destino", "Estado", "Días", "Responsable"};
        for (int i = 0; i < headers.length; i++) {
            Cell cell = headerRow.createCell(i);
            cell.setCellValue(headers[i]);
            cell.setCellStyle(headerStyle);
        }
        
        // Data
        for (com.ypacarai.cooperativa.activos.model.ReporteTraslados item : reportes) {
            Row row = sheet.createRow(startRow++);
            row.createCell(0).setCellValue(item.getNumeroActivo());
            row.createCell(1).setCellValue(item.getTipoActivo());
            row.createCell(2).setCellValue(item.getUbicacionOrigen());
            row.createCell(3).setCellValue(item.getUbicacionDestino());
            row.createCell(4).setCellValue(item.getEstadoTraslado());
            row.createCell(5).setCellValue(item.getDiasEnUbicacion());
            row.createCell(6).setCellValue(item.getResponsableEnvio());
            
            // Aplicar estilo
            for (int i = 0; i < 7; i++) {
                row.getCell(i).setCellStyle(dataStyle);
            }
        }
    }
    
    // Traslados - CSV
    @SuppressWarnings("unchecked")
    private static void escribirCSVTraslados(List<?> datos, FileWriter writer) throws IOException {
        List<com.ypacarai.cooperativa.activos.model.ReporteTraslados> reportes = 
            (List<com.ypacarai.cooperativa.activos.model.ReporteTraslados>) datos;
        
        // Headers
        writer.write("Numero Activo,Tipo Activo,Ubicacion Origen,Ubicacion Destino,Estado Traslado,Dias en Ubicacion,Responsable Envio\n");
        
        // Data
        for (com.ypacarai.cooperativa.activos.model.ReporteTraslados item : reportes) {
            writer.write(String.format("%s,%s,%s,%s,%s,%d,%s\n",
                csvEscape(item.getNumeroActivo()),
                csvEscape(item.getTipoActivo()),
                csvEscape(item.getUbicacionOrigen()),
                csvEscape(item.getUbicacionDestino()),
                csvEscape(item.getEstadoTraslado()),
                item.getDiasEnUbicacion(),
                csvEscape(item.getResponsableEnvio())
            ));
        }
    }
    
    // ================== MÉTODOS DE UTILIDAD ==================
    
    private static String csvEscape(String value) {
        if (value == null) return "";
        return "\"" + value.replace("\"", "\"\"") + "\"";
    }
    
    /**
     * Método de utilidad para formatear números en reportes
     */
    public static String formatearNumero(Object numero) {
        if (numero == null) return "0";
        
        if (numero instanceof Double) {
            return String.format("%.2f", (Double) numero);
        } else if (numero instanceof Float) {
            return String.format("%.2f", (Float) numero);
        } else if (numero instanceof Integer) {
            return String.format("%,d", (Integer) numero);
        }
        
        return numero.toString();
    }
    
    /**
     * Método de utilidad para formatear fechas en reportes
     */
    public static String formatearFecha(Object fecha) {
        if (fecha == null) return "N/A";
        
        if (fecha instanceof LocalDateTime) {
            return ((LocalDateTime) fecha).format(DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm"));
        } else if (fecha instanceof java.time.LocalDate) {
            return ((java.time.LocalDate) fecha).format(DateTimeFormatter.ofPattern("dd/MM/yyyy"));
        }
        
        return fecha.toString();
    }
}